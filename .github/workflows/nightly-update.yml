name: nightly-dependency-update

on:
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install .NET SDK (LTS)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $installDir = Join-Path $env:USERPROFILE ".dotnet"
          Invoke-WebRequest https://dot.net/v1/dotnet-install.ps1 -OutFile dotnet-install.ps1
          ./dotnet-install.ps1 -Channel LTS -InstallDir $installDir
          Add-Content -Path $env:GITHUB_PATH -Value $installDir
          Add-Content -Path $env:GITHUB_ENV -Value "DOTNET_ROOT=$installDir"

      - name: Install .NET SDK (8.0)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $installDir = Join-Path $env:USERPROFILE ".dotnet8"
          Invoke-WebRequest https://dot.net/v1/dotnet-install.ps1 -OutFile dotnet-install.ps1
          ./dotnet-install.ps1 -Channel 8.0 -InstallDir $installDir
          Add-Content -Path $env:GITHUB_ENV -Value "DOTNET_8_ROOT=$installDir"
          Add-Content -Path $env:GITHUB_PATH -Value $installDir

      - name: Install dotnet-outdated-tool
        shell: pwsh
        env:
          DOTNET_ROOT: ${{ env.DOTNET_8_ROOT }}
          DOTNET_MULTILEVEL_LOOKUP: 0
        run: |
          $dotnet8 = Join-Path $env:DOTNET_8_ROOT "dotnet.exe"
          & $dotnet8 tool install --global dotnet-outdated-tool

      - name: List installed workloads
        shell: pwsh
        env:
          DOTNET_ROOT: ${{ env.DOTNET_8_ROOT }}
          DOTNET_MULTILEVEL_LOOKUP: 0
        run: |
          $dotnet8 = Join-Path $env:DOTNET_8_ROOT "dotnet.exe"
          & $dotnet8 workload list

      - name: List available workloads
        shell: pwsh
        env:
          DOTNET_ROOT: ${{ env.DOTNET_8_ROOT }}
          DOTNET_MULTILEVEL_LOOKUP: 0
        run: |
          $dotnet8 = Join-Path $env:DOTNET_8_ROOT "dotnet.exe"
          & $dotnet8 workload search

      - name: Update NuGet packages
        shell: pwsh
        env:
          DOTNET_ROOT: ${{ env.DOTNET_8_ROOT }}
          DOTNET_MULTILEVEL_LOOKUP: 0
        run: |
          $dotnet8 = Join-Path $env:DOTNET_8_ROOT "dotnet.exe"
          & $dotnet8 outdated Launcher_WPF/Launcher_WPF.csproj -u
          & $dotnet8 outdated MeineApp/MeineApp.csproj -u

      - name: Update target framework to latest .NET LTS
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $ltsMajor = dotnet --list-sdks |
            ForEach-Object { ($_ -split '\s+')[0] } |
            ForEach-Object { ($_ -split '\.')[0] } |
            Sort-Object {[int]$_} |
            Select-Object -Last 1

          if (-not $ltsMajor) {
            Write-Error "Could not determine .NET SDK major version."
            exit 1
          }

          $replacement = "<TargetFramework>net$ltsMajor.0-windows</TargetFramework>"
          $projects = @(
            "Launcher_WPF/Launcher_WPF.csproj",
            "MeineApp/MeineApp.csproj"
          )

          foreach ($project in $projects) {
            (Get-Content $project) -replace "<TargetFramework>net[0-9]+\.0-windows</TargetFramework>", $replacement |
              Set-Content $project
          }

      - name: Configure DesktopBridge path
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $desktopBridgePath = Join-Path ${env:ProgramFiles(x86)} "MSBuild\Microsoft\DesktopBridge\"
          $propsPath = Join-Path $desktopBridgePath "Microsoft.DesktopBridge.props"

          if (-not (Test-Path $propsPath)) {
            Write-Warning "DesktopBridge props not found at $propsPath. Skipping MSIX packaging build."
            Add-Content -Path $env:GITHUB_ENV -Value "DesktopBridgeAvailable=false"
            return
          }

          Add-Content -Path $env:GITHUB_ENV -Value "WapProjPath=$desktopBridgePath"
          Add-Content -Path $env:GITHUB_ENV -Value "DesktopBridgeAvailable=true"

      - name: Build solution
        shell: pwsh
        run: |
          if ($env:DesktopBridgeAvailable -eq "true") {
            dotnet build Launcher.sln -c Release
            return
          }

          dotnet build Launcher_WPF/Launcher_WPF.csproj -c Release
          dotnet build MeineApp/MeineApp.csproj -c Release

      - name: Show installed SDK
        shell: pwsh
        run: dotnet --version

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update nuget packages"
          title: "chore: nightly dependency update"
          body: |
            - Update NuGet packages using dotnet-outdated.
            - Use the latest .NET LTS SDK during the update run.
          branch: chore/nightly-dependency-update
          delete-branch: true
